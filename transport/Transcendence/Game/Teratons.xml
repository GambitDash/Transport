<?xml version="1.0" ?>

<TranscendenceModule>

	<!-- Teraton Defense Satellite -->

	<StationType UNID="&stTeratonDefender;"
			name=				"Teraton Defender"
			sovereign=			"&svIndependentTrader;"
			abandonedScreen=	"&dsAbandonedStation;"
			dockingPorts=		"4"
			noMapLabel=			"true"
			noFriendlyFire=		"true"
			canAttack=			"true"

			multiHull=			"true"
			mass=				"5000"
			armorID=			"&itLightIthaliumArmor;"
			maxHitPoints=		"100"
			maxStructuralHitPoints="40"
			fireRateAdj=		"20"
			ejectaType=			"&vtWreckEjecta;"
			>

		<Image			imageID="&rsTeratonDefender;" imageX="0" imageY="0" imageWidth="64" imageHeight="64" imageFrameCount="12" imageTicksPerFrame="2"/>

		<Devices>
			<Device deviceID="&itKytrynBlaster;"	omnidirectional="true"/>
			</Devices>

		</StationType>

	<!-- Teraton Factory -->

	<StationType UNID="&stTeratonFactory;"
			name=				"(teraton factory)"
			sovereign=			"&svIndependentTrader;"
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"

			multiHull=			"true"
			armorID=			"&itIthaliumArmor;"
			maxHitPoints=		"850"
			hitPoints=			"850"
			repairRate=			"10"
			fireRateAdj=		"10"
			explosionType=		"&vtPlasmaExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"independent,friendly,envAir,envAvoidsFire,populated"
			levelFrequency=		"----- --ruv ----- ----- -----"
			locationCriteria=	"+OuterSystem,-void"
			>
			
		<Names>Teraton Nest</Names>

		<Image			imageID="&rsStations9;" imageX="0" imageY="0" imageWidth="256" imageHeight="256"/>

		<Items>
			<RandomItem count="20" 
					criteria=		"* +Res;"
					level=			"7"
					levelCurve=		"3"
					/>
			<RandomItem count="10" 
					criteria=		"f"
					level=			"8"
					levelCurve=		"3"
					/>
		</Items>

		<Satellites>
			<Orbitals count="1d3+2" distance="1d8+6" angle="random">
				<Station type="&stTeratonDefender;"/>
			</Orbitals>
		</Satellites>

		<Events>
			<OnDestroy>
				(intTeratonOnDestroy)
			</OnDestroy>
		</Events>
		
		<StaticData>
			<FactoryTable>
				(	; pattern				minM	minE	minD	chgM	chgE	chgD	output		output level
					(&itRingerAmbrosia;		Nil		Nil		Nil		0		0		+5		Nil			Nil)
					(&itRingerSpice;		Nil		Nil		Nil		0		0		+1		Nil			Nil)
					(&itRadioactiveWaste;	Nil		Nil		Nil		0		-1		-5		Nil			Nil)
					(&itOrganicAcid;		Nil		Nil		Nil		0		0		-1		Nil			Nil)
					("* +Soul;"				Nil		Nil		Nil		0		0		"+l"	Nil			Nil)
					("* +Food; +Lux;"		Nil		1		Nil		0		-1		+1		Nil			Nil)
					("* +Res; +ZeroPoint;"	Nil		Nil		Nil		0		"+1"	0		Nil			Nil)
					("* +Res; +AntiMatter;"	Nil		Nil		Nil		0		"+1"	0		Nil			Nil)
					("* +Res; +Nuclear;"	Nil		Nil		Nil		0		"+1"	0		Nil			Nil)
					("* +Res;"				Nil		Nil		Nil		"+l"	0		0		Nil			Nil)
					("f"					Nil		Nil		Nil		0		"+l"	0		Nil			Nil)
					("a"					Nil		1		Nil		"+l"	-1		0		Nil			Nil)
					("* +Meds;"				Nil		Nil		Nil		0		0		"-l"	Nil			Nil)
					("w &lt;8"				"+2l"	"+2l"	2		"-2l"	"-2l"	-2		"w"			"l+1")
					("w &lt;8"				"+2l"	"+2l"	Nil		"-2l"	"-2l"	0		"w"			"l")
					("w &lt;8"				Nil		Nil		Nil		"+l"	"+l"	-1		Nil			Nil)
					("w &lt;11"				"+2l"	"+2l"	5		"-2l"	"-2l"	-5		"w"			"l+1")
					("w &lt;11"				"+2l"	"+2l"	2		"-2l"	"-2l"	-2		"w"			"l")
					("w &lt;11"				Nil		Nil		Nil		"+l"	"+l"	"-l"	Nil			Nil)
					("s &lt;8"				"+l"	"+l"	1		"-l"	"-l"	-1		"s"			"l+1")
					("s &lt;8"				"+l"	"+l"	Nil		"-l"	"-l"	0		"s"			"l")
					("s &lt;8"				Nil		Nil		Nil		"+l"	"+l"	-1		Nil			Nil)
					("s &lt;11"				"+l"	"+l"	5		"-l"	"-l"	-5		"s"			"l+1")
					("s &lt;11"				"+l"	"+l"	1		"-l"	"-l"	-1		"s"			"l")
					("s &lt;11"				Nil		Nil		Nil		"+l"	"+l"	"-l"	Nil			Nil)
					("vr &lt;8"				"+l"	"+2l"	1		"-l"	"-2l"	-1		"vr"		"l+1")
					("vr &lt;8"				"+l"	"+2l"	Nil		"-l"	"-2l"	0		"vr"		"l")
					("vr &lt;8"				Nil		Nil		Nil		"+l"	"+l"	0		Nil			Nil)
					("vr &lt;11"			"+l"	"+2l"	5		"-l"	"-2l"	-5		"vr"		"l+1")
					("vr &lt;11"			"+l"	"+2l"	1		"-l"	"-2l"	-1		"vr"		"l")
					("vr &lt;11"			Nil		Nil		Nil		"+l"	"+l"	0		Nil			Nil)
					("d~swvr &lt;8"			"+l"	"+l"	1		"-l"	"-l"	-1		"d~swvr"	"l+1")
					("d~swvr &lt;8"			"+l"	"+l"	Nil		"-l"	"-l"	0		"d~swvr"	"l")
					("d~swvr &lt;8"			Nil		Nil		Nil		"+l"	"+l"	0		Nil			Nil)
					("d~swvr &lt;11"		"+l"	"+l"	5		"-l"	"-l"	-5		"d~swvr"	"l+1")
					("d~swvr &lt;11"		"+l"	"+l"	1		"-l"	"-l"	-1		"d~swvr"	"l")
					("d~swvr &lt;11"		Nil		Nil		Nil		"+l"	"+l"	0		Nil			Nil)
					("m &lt;11"				"+l"	"+l"	Nil		"-l"	"-l"	0		"replicate"	Nil)
					("m &lt;16"				"+2l"	"+2l"	Nil		"-2l"	"-2l"	0		"replicate"	Nil)
					(Nil					Nil		Nil		Nil		0		0		0		Nil			Nil)
					)
			</FactoryTable>
		</StaticData>
		
		<InitialData>
			<energy>0</energy>
			<material>0</material>
			<disposition>0</disposition>
		</InitialData>
		
		<DockScreens>
			<Main
				name=			"=(objGetName gSource)"
				>

				<OnInit>
					(if (not (objGetData gPlayerShip "rins"))
						(objSetData gPlayerShip "rins" 0)
						)
				</OnInit>
					
				<Panes>
					<Default
							desc=	"You are in the peripheral tunnel of a Teraton nest. The hard walls are covered by a sinewous membrane and odd growths hang from the ceiling. There is a foul smell of rot and bile in the air.">

						<Actions>
							<Action name="Fabricator Chamber" default="1" key="F">
								<Navigate screen="Factory"/>
							</Action>
							
							<Action name="Trading Chamber" key="T">
								(intTeratonMugging "Exchange")
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>

					</Default>

					<Exchange
							desc=	"The Trading Chamber is a vast, dark cavern where Teratons trade with various human and neo-humans. From a distance the Teratons look like abnormally tall humans, but up close you notice their deformities and mutations.">

						<Actions>
							<Action name="Buy items" default="1" key="B">
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "Exchange")
									(setq gMargin intTeratonBuyMargin)
									(scrShowScreen gScreen "&dsRingerBuy;")
									)
							</Action>

							<Action name="Sell items" key="S">
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "Exchange")
									(setq gMargin intTeratonSellMargin)
									(scrShowScreen gScreen "&dsRingerSell;")
									)
							</Action>

							<Action name="Done" cancel="1" key="D">
								<ShowPane pane="Default"/>
							</Action>

						</Actions>
					</Exchange>
				</Panes>
			</Main>

			<Factory
				name=			"=(objGetName gSource)"
				>
				
				<Panes>
					<Default>
					
						<Initialize>
							(block (disposition)
								(setq disposition (objGetData gSource "disposition"))
								(scrSetDesc gScreen
									(cat "You are in the vast central chamber of the Teraton nest. A large pit in the center of the cavern is inhabited by a mass of tentacles, cilia, and grotesque organs.\n\n"
										(switch
											(ls disposition 0)
												"The organic mass appears restless and angry."
												
											(geq disposition 5)
												"The organic mass purrs with contentment."
												
											(geq disposition 2)
												"The organic mass appears calm."
												
											""
											)
										)
									)
								)
						</Initialize>
						
						<Actions>
							<Action name="Drop item in pit" default="1" key="D">
								<Navigate screen="DropItem"/>
							</Action>
							
							<Action name="Leave" cancel="1" key="L">
								<Navigate screen="Main"/>
							</Action>
						</Actions>
					</Default>
					
					<Result>
						<Initialize>
							(scrSetDesc gScreen gResult)
						</Initialize>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(if (and (ls (objGetData gSource "disposition") -9) (leq (random 1 100) 25))
									(scrShowPane gScreen "AngryTentacles")
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</Result>
					
					<AngryTentacles>
						<Initialize>
							(block Nil
								(scrSetDesc gScreen "Angered by your offerings, the tentacles of the pit reach out to grab you. Before you can run, they slip around your neck and waist and pull you down into the pit.\n\nYou are dissolved by the various acids and enzymes of the grotesque organic mass.")
								(plyDestroyed gPlayer "killed by an angry Teraton fabricator")
								)
						</Initialize>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								<Exit/>
							</Action>
						</Actions>
					</AngryTentacles>
				</Panes>
			</Factory>

			<DropItem
				name=			"=(objGetName gSource)"
				type=			"itemPicker"
				backgroundID=	"&rsItemListScreen;"
				>

				<ListOptions
					dataFrom=	"player"
					list=		"*U"
					/>

				<Panes>
					<Default
							desc=	"There are no items here.">

						<Initialize>
							(block (enableDrop)
								(setq gItem (scrGetItem gScreen))
								(if gItem
									(block Nil
										(scrSetDesc gScreen "What item do you wish to drop into the Teraton pit?")
										(scrEnableAction gScreen 0 True)
										)
									(scrEnableAction gScreen 0 Nil)
									)
								)
						</Initialize>

						<Actions>
							<Action name="Drop this item" default="1" key="D">
								(block (table entry criteria material energy disposition)
									(setq gItem (scrGetItem gScreen))
									
									; Load some variables
									(setq energy (objGetData gSource "energy"))
									(setq material (objGetData gSource "material"))
									(setq disposition (objGetData gSource "disposition"))
									
									; Look for the entry in the table
									(setq table (objGetStaticData gSource "FactoryTable"))
									(setq entry Nil)
									(enumwhile table (not entry) thisEntry
										(switch
											; Skip if not enough material
											(ls material (intTeratonGetValue (item thisEntry 1) gItem))
												Nil
												
											; Skip if not enough energy
											(ls energy (intTeratonGetValue (item thisEntry 2) gItem))
												Nil
												
											; Skip if not enough disposition
											(ls disposition (intTeratonGetValue (item thisEntry 3) gItem))
												Nil
											
											; If the criteria in the table is Nil, then we always match. This
											; is for the last (default) entry.
											(not (setq criteria (item thisEntry 0)))
												(setq entry thisEntry)
												
											; If the criteria is an integer, then we see if this is the UNID
											; of the item.
											(isint criteria)
												(if (eq (itmGetUNID gItem) criteria)
													(setq entry thisEntry)
													)
												
											; If the criteria matches, then we have an entry
											(itmMatches gItem criteria)
												(setq entry thisEntry)
											)
										)
									
									; Consume the item	
									(objRemoveItem gPlayerShip gItem 1)
									
									; Figure out the result
									(if entry
										(block (incEnergy incMaterial incDisposition output newItem)
											(setq incMaterial (intTeratonGetValue (item entry 4) gItem))
											(setq incEnergy (intTeratonGetValue (item entry 5) gItem))
											(setq incDisposition (intTeratonGetValue (item entry 6) gItem))

											(setq output (item entry 7))
											(switch
												(not output)
													(setq newItem Nil)
													
												(eq output "replicate")
													(setq newItem (itmCreate (itmGetUNID gItem) (random 8 12)))
													
												(isint output)
													(setq newItem (itmCreate output 1))
													
												(setq newItem (itmCreateRandom output (intTeratonGetLevelCurve (item entry 8) gItem)))
												)
												
											; State changes
											(objIncData gSource "material" incMaterial)
											(objIncData gSource "energy" incEnergy)
											(objIncData gSource "disposition" incDisposition)
											(if newItem
												(objAddItem gPlayerShip newItem)
												)
												
											; Compute the result description string
											(switch
												newItem
													(setq gResult (cat "Tentacles reach out to accept your offering and the organic mass swallows it with a hiss. Organs gurgle and glow for a while, and then tentacles pull a slimy mass out of some orifice and deposit it at your feet.\n\nYou see " (itmGetName newItem 8) "."))
													
												(gr incDisposition 0)
													(setq gResult "Tentacles eagerly reach out to accept your offering and the organic mass swallows it with a hiss.\n\nThe organic mass spews a sweet, pleasant mist.")
													
												(ls incDisposition 0)
													(setq gResult "Tentacles reach out to accept your offering and the organic mass tentatively swallows it.\n\nWith a roar of anger, the organic mass spews a thick mist of bile. You are covered in a slimy broth of chemicals.")
													
												(or (gr incMaterial 0) (gr incEnergy 0))
													(setq gResult "Tentacles reach out to accept your offering and the organic mass swallows it.\n\nOrgans and bladers gurgle as they process the material you have fed them.")
													
												(setq gResult "Tentacles reach out to accept your offering, but after a tentative taste, they crush it and discard it through one of the many tunnels along the wall of the pit.")
												)
												
											; DEBUG
											; (setq gResult (cat gResult "\n\nM=" (objGetData gSource "material") " E=" (objGetData gSource "energy") " D=" (objGetData gSource "disposition")))
											)
										(setq gResult "Tentacles reach out to accept your offering, but after a tentative taste, they crush it and discard it through one of the many tunnels along the wall of the pit.")
										)
										
									; Next
									(scrShowScreen gScreen "Factory" "Result")
									)
							</Action>

							<Action name="Cancel" cancel="1" key="C">
								<Navigate screen="Factory"/>
							</Action>
						</Actions>
					</Default>
					
				</Panes>
			</DropItem>

		</DockScreens>

		<DockingPorts>
			<Port x="-64"	y="77" />
			<Port x="-32"	y="126" />
			<Port x="0"		y="77" />
			<Port x="78"	y="-20" />
			<Port x="124"	y="-80" />
			<Port x="54"	y="-80" />
			<Port x="-40"	y="-68" />
			<Port x="-106"	y="-64" />
			<Port x="-72"	y="0" />
		</DockingPorts>

	</StationType>

	<!-- Teraton Research Center -->

	<StationType UNID="&stTeratonResearch;"
			name=				"(teraton research center)"
			sovereign=			"&svIndependentTrader;"
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"

			multiHull=			"true"
			armorID=			"&itIthaliumArmor;"
			maxHitPoints=		"850"
			hitPoints=			"850"
			repairRate=			"10"
			fireRateAdj=		"10"
			explosionType=		"&vtPlasmaExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"independent,friendly,envAir,envAvoidsFire,populated"
			levelFrequency=		"----- --rr- ----- ----- -----"
			locationCriteria=	"+OuterSystem,-void"
			>
			
		<Names>Teraton Nest</Names>

		<Image			imageID="&rsStations9;" imageX="0" imageY="0" imageWidth="256" imageHeight="256"/>

		<Items>
			<RandomItem count="12" 
					criteria=		"*"
					level=			"7"
					levelCurve=		"1"
					/>
			<RandomItem count="1d2" 
					criteria=		"* +Alien;"
					level=			"9"
					levelCurve=		"3"
					/>
		</Items>

		<Satellites>
			<Orbitals count="1d3+2" distance="1d8+6" angle="random">
				<Station type="&stTeratonDefender;"/>
			</Orbitals>
		</Satellites>

		<Events>
			<OnDestroy>
				(intTeratonOnDestroy)
			</OnDestroy>
		</Events>
		
		<DockScreens>
			<Main
				name=			"=(objGetName gSource)"
				>

				<OnInit>
					(if (not (objGetData gPlayerShip "rins"))
						(objSetData gPlayerShip "rins" 0)
						)
				</OnInit>
					
				<Panes>
					<Default
							desc=	"You are in the peripheral tunnel of a Teraton nest. The hard walls are covered by a sinewous membrane and odd growths hang from the ceiling. There is a foul smell of rot and bile in the air.">

						<Actions>
							<Action name="Research Chamber" default="1" key="R">
								(if (or (not (objGetData gSource "LastExperiment"))
										(gr (subtract (unvGetTime) (objGetData gSource "LastExperiment")) 3600))
									(scrShowPane gScreen "Research")
									(scrShowPane gScreen "ResearchNone")
									)
							</Action>
							
							<Action name="Trading Chamber" key="T">
								(intTeratonMugging "Exchange")
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>

					</Default>
					
					<Research>
						<Initialize>
							(scrSetDesc gScreen
								"You enter a dim cavern filled with arcane equipment. Dozens of human subjects, wired, tubed, and in various stages of health and wholeness, lie on articulated beds.\n\nA tall Teraton with supernumerary fingers approaches you. \"Human! You desire to join the research? You will be compensated with gifts from beyond.\""
								)
						</Initialize>
							
						<Actions>
							<Action name="&quot;Sure&#x97;anything for the advancement of science.&quot;" default="1" key="S">
								(block (dieRoll)
									(setq dieRoll (random 1 100))
									(switch
										; Physical mutilation
										(leq dieRoll 15)
											(block Nil
												(switch
													(leq (random 1 100) 95)
														(setq gResult "success")
														
													(intConsumeItem gPlayerShip (itmCreate &itArtificialPlasma; 1))
														(setq gResult "use-plasma")
														
													(objHasItem gPlayerShip (itmCreate &itPortableAutodoc; 1))
														(setq gResult "use-autodoc")
														
													(setq gResult "death")
													)
													
												(scrShowPane gScreen "ResearchMutilation")
												)
												
										; Filovirus
										(leq dieRoll 50)
											(block Nil
												(switch
													(leq (random 1 100) 85)
														(setq gResult "success")
														
													(intConsumeItem gPlayerShip (itmCreate &itCyanavir; 1))
														(setq gResult "use-cyanavir")
														
													(objHasItem gPlayerShip (itmCreate &itPortableAutodoc; 1))
														(setq gResult "use-autodoc")
														
													(setq gResult "death")
													)
													
												(scrShowPane gScreen "ResearchFilovirus")
												)
												
										; Mutagens
										(leq dieRoll 85)
											(block Nil
												(switch
													(leq (random 1 100) 67)
														(setq gResult "success")
														
													(intConsumeItem gPlayerShip (itmCreate &itDeathDrugs; 1))
														(setq gResult "use-deathdrugs")
														
													(objHasItem gPlayerShip (itmCreate &itPortableAutodoc; 1))
														(setq gResult "use-autodoc")
														
													(setq gResult "death")
													)
													
												(scrShowPane gScreen "ResearchMutagen")
												)
												
										; Alien parasite
										(leq dieRoll 100)
											(block Nil
												(switch
													(intConsumeItem gPlayerShip (itmCreate &itHypermycin; 1))
														(if (leq (random 1 100) 95)
															(setq gResult "use-hypermycin")
															(setq gResult "death")
															)
														
													(objHasItem gPlayerShip (itmCreate &itPortableAutodoc; 1))
														(if (leq (random 1 100) 80)
															(setq gResult "use-autodoc")
															(setq gResult "death")
															)
														
													(setq gResult "death")
													)
													
												(scrShowPane gScreen "ResearchParasite")
												)
										)
									)
							</Action>
							
							<Action name="&quot;No thanks.&quot;" cancel="1" key="N">
								<ShowPane pane="ResearchDecline"/>
							</Action>
						</Actions>
					</Research>
					
					<ResearchNone
							desc=	"You enter a dim cavern filled with arcane equipment. Dozens of human subjects, wired, tubed, and in various stages of health and wholeness, lie on articulated beds. A tall Teraton with supernumerary fingers tends to the patients with a mixture of curiosity and concern.">
						<Actions>
							<Action name="Leave" cancel="1" default="1" key="L">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>
					</ResearchNone>
					
					<ResearchMutilation
							desc=	"The Teraton takes you to an empty bed and straps you down so that you cannot move. It then takes a scalpel and slices open both your forearms from the elbow to the wrist. You bleed profusely and mercifully pass out after a few minutes of screaming.">
						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								<ShowPane pane="ResearchMutilation2"/>
							</Action>
						</Actions>
					</ResearchMutilation>
					
					<ResearchMutilation2>
						<Initialize>
							(switch
								(eq gResult "success")
									(scrSetDesc gScreen "You wake up in the nightmarish chamber and notice that both your arms are bandaged up.\n\nThe Teraton attempts a smile and says, \"Human! Your body is weak and easily killed. We have repaired as best as possible. For your pains we will reward you.\"")
									
								(eq gResult "use-plasma")
									(scrSetDesc gScreen "You wake up in your ship with bloody bandages over both your arms. You open a case of artificial plasma and set up a transfusion.\n\nYou start to feel better after an hour.")
									
								(eq gResult "use-autodoc")
									(scrSetDesc gScreen "You wake up in your ship with bloddy bandages over both your arms. You activate your portable autodoc and it drips a concoction of fluids and growth stims into your arm.\n\nYou start to feel better immediately.")

								(block Nil									
									(scrSetDesc gScreen "Overnight your blood pressure drops as the bleeding continues.\n\nIn the morning, the Teraton takes your lifeless body and dumps it into space.")
									(plyDestroyed gPlayer (cat "killed in a Teraton medical experiment"))
									)
								)
						</Initialize>
						
						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								(if (eq gResult "death")
									(scrExitDock gScreen)
									(scrShowPane gScreen "ResearchGift")
									)
							</Action>
						</Actions>
					</ResearchMutilation2>
					
					<ResearchFilovirus
							desc=	"The Teraton takes you to an empty bed and straps you down so that you cannot move. It then takes a syringe and injects you with something. At first you feel OK, but after a few hours you ache all over and begin to vomit. After a couple of days you begin to bleed from every orifice and you mercifully fall into a coma.">
						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								<ShowPane pane="ResearchFilovirus2"/>
							</Action>
						</Actions>
					</ResearchFilovirus>
					
					<ResearchFilovirus2>
						<Initialize>
							(switch
								(eq gResult "success")
									(scrSetDesc gScreen "You wake up in the nightmarish chamber, a taste of vomit in your mouth, but otherwise OK.\n\nThe Teraton attempts a smile and says, \"Human! Your body is weak and easily killed. We have repaired as best as possible. For your pains we will reward you.\"")
									
								(eq gResult "use-cyanavir")
									(scrSetDesc gScreen "You wake up in your ship covered in blood and vomit. You dose yourself with a course of cyanavir and try to sleep it off.\n\nAfter several days you recover enough to be able to eat again.")
									
								(eq gResult "use-autodoc")
									(scrSetDesc gScreen "You wake up in your ship covered in blood and vomit. You activate your portable autodoc and it drips a concoction of antivirals into your arm.\n\nYou start to feel better after a few days.")

								(block Nil
									(scrSetDesc gScreen "Overnight you crash out as your organs liquify from the viral load.\n\nIn the morning, the Teraton carefully places your lifeless form into a body bag and dumps it into space.")
									(plyDestroyed gPlayer (cat "killed in a Teraton medical experiment"))
									)
								)
						</Initialize>
						
						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								(if (eq gResult "death")
									(scrExitDock gScreen)
									(scrShowPane gScreen "ResearchGift")
									)
							</Action>
						</Actions>
					</ResearchFilovirus2>
					
					<ResearchMutagen
							desc=	"The Teraton takes you to an empty bed and straps you down so that you cannot move. It then opens up a large jar and carefully removes what looks like a cancerous growth. Slicing your chest with quick strokes, the Teraton implants the growth into your body. You pass out from the pain before it finishes.">
						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								<ShowPane pane="ResearchMutagen2"/>
							</Action>
						</Actions>
					</ResearchMutagen>
					
					<ResearchMutagen2>
						<Initialize>
							(switch
								(eq gResult "success")
									(scrSetDesc gScreen "You wake up in the nightmarish chamber, a large bandage covering your chest.\n\nThe Teraton attempts a smile and says, \"Human! Your body is weak and easily killed. We have repaired as best as possible. For your pains we will reward you.\"")
									
								(eq gResult "use-deathdrugs")
									(scrSetDesc gScreen "You wake up in your ship covered in blood. You dose yourself with a course of cancer dust and try to sleep it off.\n\nAfter several days you recover enough to be able to eat again.")
									
								(eq gResult "use-autodoc")
									(scrSetDesc gScreen "You wake up in your ship covered in blood. You activate your portable autodoc and it drips a concoction of oncokillers into your arm.\n\nYou start to feel better after a few days.")
	
								(block Nil								
									(scrSetDesc gScreen "For days, the growth inside your chest gets bigger, feeding on your blood supply. After a month, the cancer metastasizes to your eyes and mouth.\n\nAfter two months, the Teraton dumps your lifeless body into space.")
									(plyDestroyed gPlayer (cat "killed in a Teraton medical experiment"))
									)
								)
						</Initialize>
						
						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								(if (eq gResult "death")
									(scrExitDock gScreen)
									(scrShowPane gScreen "ResearchGift")
									)
							</Action>
						</Actions>
					</ResearchMutagen2>
					
					<ResearchParasite
							desc=	"The Teraton takes you to an empty bed and straps you down so that you cannot move. It then opens up a small jar and carefully removes a translucent and gelatinous eel of some sort. Holding your head steady, it guides the eel into your nasal passage. The eel seems undisturbed by your piercing screams.">
						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								<ShowPane pane="ResearchParasite2"/>
							</Action>
						</Actions>
					</ResearchParasite>
					
					<ResearchParasite2>
						<Initialize>
							(switch
								(eq gResult "use-hypermycin")
									(scrSetDesc gScreen "You wake up in your ship with a splitting headache and a nasty nose bleed. You dose yourself with a course of hypermycin and try to sleep it off.\n\nOne morning you find a shriveled and desiccated eel by your pillow, and after that the headaches disappear.")
									
								(eq gResult "use-autodoc")
									(scrSetDesc gScreen "You wake up in your ship with a splitting headache and a nasty nose bleed. You activate your portable autodoc and it drips a concoction of antibiotics into your arm.\n\nOne morning you find a shriveled and desiccated eel by your pillow, and after that the headaches disappear.")

								(block Nil									
									(scrSetDesc gScreen "For days the eel grows inside your head, eating everything before it. Fortunately, the damage to your brain slips you into a deep catatonia and you feel nothing.\n\nAfter a month, the Teraton takes your lifeless body and dumps it into space.")
									(plyDestroyed gPlayer (cat "killed in a Teraton medical experiment"))
									)
								)
						</Initialize>
						
						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								(if (eq gResult "death")
									(scrExitDock gScreen)
									(scrShowPane gScreen "ResearchGift")
									)
							</Action>
						</Actions>
					</ResearchParasite2>
					
					<ResearchGift>
						<Initialize>
							(block (dieRoll)
								(setq dieRoll (random 1 100))
								(switch
									(leq dieRoll 40)
										(setq gItem (itmCreate &itPromethiumCrystal; 1))
										
									(leq dieRoll 75)
										(setq gItem (itmCreateRandom "* +Res;" "----- -ccur"))
										
									(leq dieRoll 100)
										(setq gItem (itmCreateRandom "wsd +MajorItem;" "----- -c---"))
									)
									
								(scrSetDesc gScreen
									(cat "Once you've recovered, the Teraton comes to your ship, \"Human! This payment compensates for your damage.\""
										"\n\nIt drops off " (itmGetName gItem 8) " and leaves without another word."
										)
									)
								)
						</Initialize>
						
						<Actions>
							<Action name="Leave" cancel="1" default="1" key="L">
								(block Nil
									(objAddItem gPlayerShip gItem)
									(objSetData gSource "LastExperiment" (unvGetTick))
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</ResearchGift>
					
					<ResearchDecline
							desc=	"The Teraton growls in disappointment. He turns away and continues his work on the human subjects.">
							
						<Actions>
							<Action name="Leave" cancel="1" default="1" key="L">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>
					</ResearchDecline>

					<Exchange
							desc=	"The Trading Chamber is a vast, dark cavern where Teratons trade with various human and neo-humans. From a distance the Teratons look like abnormally tall humans, but up close you notice their deformities and mutations.">

						<Actions>
							<Action name="Buy items" default="1" key="B">
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "Exchange")
									(setq gMargin intTeratonBuyMargin)
									(scrShowScreen gScreen "&dsRingerBuy;")
									)
							</Action>

							<Action name="Sell items" key="S">
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "Exchange")
									(setq gMargin intTeratonSellMargin)
									(scrShowScreen gScreen "&dsRingerSell;")
									)
							</Action>

							<Action name="Leave" cancel="1" key="L">
								<ShowPane pane="Default"/>
							</Action>

						</Actions>
					</Exchange>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="-64"	y="77" />
			<Port x="-32"	y="126" />
			<Port x="0"		y="77" />
			<Port x="78"	y="-20" />
			<Port x="124"	y="-80" />
			<Port x="54"	y="-80" />
			<Port x="-40"	y="-68" />
			<Port x="-106"	y="-64" />
			<Port x="-72"	y="0" />
		</DockingPorts>

	</StationType>

	<!-- Teraton Trading Post -->

	<StationType UNID="&stTeratonTradingPost;"
			name=				"(teraton trading post)"
			sovereign=			"&svIndependentTrader;"
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"

			multiHull=			"true"
			armorID=			"&itIthaliumArmor;"
			maxHitPoints=		"850"
			hitPoints=			"850"
			repairRate=			"10"
			fireRateAdj=		"10"
			explosionType=		"&vtPlasmaExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"independent,friendly,envAir,envAvoidsFire,populated"
			levelFrequency=		"----- -vcuv ----- ----- -----"
			locationCriteria=	"+OuterSystem,-void"
			>
			
		<Names>Teraton Nest</Names>

		<Image			imageID="&rsStations9;" imageX="0" imageY="0" imageWidth="256" imageHeight="256"/>

		<Items>
			<RandomItem count="20" 
					criteria=		"*"
					level=			"7"
					levelCurve=		"1"
					/>
			<RandomItem count="10" 
					criteria=		"adm"
					level=			"8"
					levelCurve=		"1"
					/>
			<RandomItem count="5" 
					criteria=		"wm"
					level=			"9"
					levelCurve=		"2"
					/>
			<RandomItem count="5" 
					criteria=		"fmut +Consumable;"
					level=			"10"
					levelCurve=		"2"
					/>
		</Items>

		<Satellites>
			<Orbitals count="1d3+2" distance="1d8+6" angle="random">
				<Station type="&stTeratonDefender;"/>
			</Orbitals>
		</Satellites>

		<Events>
			<OnDestroy>
				(intTeratonOnDestroy)
			</OnDestroy>
		</Events>
		
		<DockScreens>
			<Main
				name=			"=(objGetName gSource)"
				>

				<OnInit>
					(if (not (objGetData gPlayerShip "rins"))
						(objSetData gPlayerShip "rins" 0)
						)
				</OnInit>
					
				<Panes>
					<Default
							desc=	"You are in the peripheral tunnel of a Teraton nest. The hard walls are covered by a sinewous membrane and odd growths hang from the ceiling. There is a foul smell of rot and bile in the air.">

						<Actions>
							<Action name="Trading Chamber" default="1" key="T">
								(intTeratonMugging "Exchange")
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>

					</Default>

					<Exchange
							desc=	"The Trading Chamber is a vast, dark cavern where Teratons trade with various human and neo-humans. From a distance the Teratons look like abnormally tall humans, but up close you notice their deformities and mutations.">

						<Actions>
							<Action name="Buy items" default="1" key="B">
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "Exchange")
									(setq gMargin intTeratonBuyMargin)
									(scrShowScreen gScreen "&dsRingerBuy;")
									)
							</Action>

							<Action name="Sell items" key="S">
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "Exchange")
									(setq gMargin intTeratonSellMargin)
									(scrShowScreen gScreen "&dsRingerSell;")
									)
							</Action>

							<Action name="Done" cancel="1" key="D">
								<ShowPane pane="Default"/>
							</Action>

						</Actions>
					</Exchange>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="-64"	y="77" />
			<Port x="-32"	y="126" />
			<Port x="0"		y="77" />
			<Port x="78"	y="-20" />
			<Port x="124"	y="-80" />
			<Port x="54"	y="-80" />
			<Port x="-40"	y="-68" />
			<Port x="-106"	y="-64" />
			<Port x="-72"	y="0" />
		</DockingPorts>

	</StationType>

	<Globals>
		(block Nil
			(setq intConsumeItem (lambda (theObj theItem)
				(if (objHasItem theObj theItem)
					(block Nil
						(objRemoveItem theObj theItem)
						True
						)
					Nil
					)
				))
				
			(setq intTeratonBuyMargin (lambda (thisItem)
				(block (cost)
					(switch
						; Better not be installed or damaged
						(or (itmIsInstalled thisItem) (itmIsDamaged thisItem))
							(setq cost 0)
						
						; Player cannot buy 'Soul' items
						(itmHasModifier thisItem "Soul")
							(setq cost 0)
							
						; 'RingerValuable' items are cheaper here
						(itmHasModifier thisItem "RingerValuable")
							(setq cost (divide (multiply (itmGetPrice thisItem) 4) 5))
							
						; 'Alien' items for 1/4 cost
						(itmHasModifier thisItem "Alien")
							(setq cost (divide (itmGetPrice thisItem) 4))
							
						; All other items for 1/5 price
						(setq cost (divide (itmGetPrice thisItem) 5))
						)

					; round up
					(setq cost (multiply (divide (add cost 4) 5) 5))

					(if (gr cost 0)
						cost
						Nil
						)
					)
				))
				
			(setq intTeratonGetLevelCurve (lambda (value theItem)
				(switch
					(isint value)
						(block (result)
							(setq result "")
							(for i 1 5 (setq result (cat result (if (eq i value) "c" "-"))))
							(setq result (cat result " "))
							(for i 6 10 (setq result (cat result (if (eq i value) "c" "-"))))
							(setq result (cat result " "))
							(for i 11 15 (setq result (cat result (if (eq i value) "c" "-"))))
							result
							)
						
					(eq value "l")
						(intTeratonGetLevelCurve (itmGetLevel theItem) theItem)
						
					(eq value "l+1")
						(intTeratonGetLevelCurve (add (itmGetLevel theItem) 1) theItem)
						
					(eq value "l-1")
						(intTeratonGetLevelCurve (subtract (itmGetLevel theItem) 1) theItem)
						
					(eq value "l+2")
						(intTeratonGetLevelCurve (add (itmGetLevel theItem) 2) theItem)
						
					"ccccc ccccc"
					)
				))
				
			(setq intTeratonGetValue (lambda (value theItem)
				(switch
					(not value)
						-1000
						
					(isint value)
						value
						
					(eq value "+l")
						(itmGetLevel theItem)
						
					(eq value "-l")
						(subtract 0 (itmGetLevel theItem))
						
					(eq value "+2l")
						(multiply (itmGetLevel theItem) 2)
						
					(eq value "-2l")
						(subtract 0 (multiply (itmGetLevel theItem) 2))
						
					0
					)
				))
				
			(setq intTeratonMugging (lambda (destination)
				(switch
					; If the player is not too powerful then there is a chance that
					; the Teratons will just take what they want.
					
					(or (and (ls (objGetCombatPower gPlayerShip) 15) (leq (random 1 100) 25))
							(and (ls (objGetCombatPower gPlayerShip) 25) (leq (random 1 100) 5)))
						(block (bestItem bestValue value)
						
							; Look for the most expensive item that the player has
							(setq bestValue 0)
							(objEnumItems gPlayerShip "*U" theItem
								(block Nil
									(setq value (multiply (intTeratonSellMargin theItem) (itmGetCount theItem)))
									(if (and value (gr value bestValue))
										(block Nil
											(setq bestItem theItem)
											(setq bestValue value)
											)
										)
									)
								)
								
							; If we found something interesting, then take it
							(if bestItem
								(block Nil
									(objRemoveItem gPlayerShip bestItem)
									(objAddItem gSource bestItem)
									
									(setq gItem bestItem)
									(scrShowScreen gScreen "&dsTeratonMugging;")
									)
								(scrShowPane gScreen destination)
								)
							)
							
					(scrShowPane gScreen destination)
					)
				))
				
			(setq intTeratonOnDestroy (lambda Nil
				(block Nil
					; Destroy items on the station
					(intDestroyItems gSource)
					)
				))
				
			(setq intTeratonSellMargin (lambda (thisItem)
				(block (cost)
					(switch
						; Better not be installed or damaged
						(or (itmIsInstalled thisItem) (itmIsDamaged thisItem))
							(setq cost 0)
						
						; We pay 1000 rin for 'Soul' items
						(itmHasModifier thisItem "Soul")
							(setq cost 1000)
							
						; We buy 'Alien' items
						(itmHasModifier thisItem "Alien")
							(setq cost (divide (itmGetPrice thisItem) 5))

						; We buy high-level resources
						(and (itmHasModifier thisItem "Res")
								(geq (itmGetLevel thisItem) 6))
							(setq cost (divide (itmGetPrice thisItem) 6))
							
						; We buy high-level weapons and ammo
						(itmMatches thisItem "wm &gt;6")
							(setq cost (divide (itmGetPrice thisItem) 7))

						; Otherwise, no sale
						(setq cost 0)
						)

					; Unknown items are discounted
					(if (not (itmIsKnown thisItem))
						(setq cost (divide cost 10))
						)
						
					; round down
					(setq cost (multiply (divide cost 5) 5))

					(if (gr cost 0)
						cost
						Nil
						)
					)
				))
			)
	</Globals>
	
	<!-- Teraton Mugging Screen -->

	<DockScreen UNID="&dsTeratonMugging;"
			name=				"=(objGetName gSource)"
			>

		<Panes>
			<Default>
				<Initialize>
					(scrSetDesc gScreen
						(cat 
							"You try to enter the Trading Chamber but a group of Teratons grab you and drag you back to your ship. Snorting with contempt for your weak ship, they rumage through your cargo hold looking for valuable items.\n\nThey take "
							(itmGetName gItem 8)
							" and leave you in pain on the deck of your ship."
							)
						)
				</Initialize>
				
				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						<Exit/>
					</Action>
				</Actions>
			</Default>
		</Panes>

	</DockScreen>

</TranscendenceModule>	
